<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://brashandplucky.com/feed.xml" title="Chema Guerra" /><!-- favicon -->
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <!-- MathJax -->
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Open Graph cards -->
    <meta property="og:url" content="https://brashandplucky.com/2025/08/25/spherical-harmonics.html">
    <meta property="og:title" content="Spherical Harmonics">
    <meta property="og:description" content="A math tool you can use to encode/decode the radiance arriving at a point with just a few coeffs.">
    <meta property="og:image" content="https://brashandplucky.com/thumbnails/2023/chemaguerra-spherical-harmonics.png">
    <meta property="og:type" content="article">
    <!-- Twitter cards -->
    <meta name="twitter:site" content="@chemaguerra">
    <meta name="twitter:creator" content="@">
    <meta name="twitter:title" content="Spherical Harmonics">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="A math tool you can use to encode/decode the radiance arriving at a point with just a few coeffs.">
    <meta name="twitter:image" content="https://brashandplucky.com/thumbnails/2023/chemaguerra-spherical-harmonics.png">
    <meta name="twitter:image:src" content="https://brashandplucky.com/thumbnails/2023/chemaguerra-spherical-harmonics.png">
    
    <!-- Make post images clickable to enlarge -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Find all images in post content and page content.
      var images = document.querySelectorAll('.post-content img, .page-content img');
      
      images.forEach(function(img) {
        // Skip if already wrapped in a link.
        if (img.parentElement.tagName === 'A') return;
        
        // Create link wrapper.
        var link = document.createElement('a');
        link.href = img.src;
        link.target = '_blank';
        link.title = 'Click to enlarge';
        
        // Wrap image with link.
        img.parentNode.insertBefore(link, img);
        link.appendChild(img);
        
        // Add cursor style.
        img.style.cursor = 'zoom-in';
      });
      
      // Make all external links open in new tab.
      var links = document.querySelectorAll('.post-content a, .page-content a');
      links.forEach(function(link) {
        // Check if link is external (not same domain).
        if (link.hostname && link.hostname !== window.location.hostname) {
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
        }
      });
    });
    </script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chema Guerra</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/archive/">Archive</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Spherical Harmonics</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-08-25T10:00:00+02:00" itemprop="datePublished">Aug 25, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <blockquote>
  <p><strong>Note:</strong> This post was written nearly 2 years ago and never published. I’m posting it now as-is, with some sections incomplete but the core content intact.</p>
</blockquote>

<p>This post is a quick crash course on what <a href="https://en.wikipedia.org/wiki/Spherical_harmonics">Spherical Harmonics</a> are and how they can be used to efficiently encode and decode <em>incoming radiance</em> (<em>i.e.,</em> a spherical view of the scene) at a point.</p>

<h2 id="motivation">Motivation</h2>

<h3 id="radiance-and-irradiance">Radiance and irradiance</h3>

<p>In the context of rendering:</p>

<p><strong>Radiance</strong> (\(L\)) is the amount of light that flows through or is emitted from a point in space in a particular direction.</p>

<p><strong>Irradiance</strong> (\(E\)) is the total amount of light energy incident upon a surface at a specific point.</p>

\[E=\int_{\Omega}{L(\mathbf{\omega})cos(\theta)\mathrm{d}\mathbf{\omega}}\]

<p>Where:</p>

<ul>
  <li>\(E\) is the irradiance at a point on the surface.</li>
  <li>\(L(\mathbf{\omega})\) is the radiance arriving from direction \(\mathbf{\omega}\).</li>
  <li>\(\theta\) is the angle between the surface normal and the direction \(\mathbf{\omega}\).</li>
  <li>\(d\mathbf{\omega}\) represents the differential solid angle in the hemisphere of incoming light directions.</li>
</ul>

<h3 id="light-probes">Light probes</h3>

<p>The definition above talks about <em>surfaces</em> (with a normal). That is, radiance arriving at the point from the positive side of the surface. However, in this post we are interested on the radiance arriving at a point from all directions:</p>

\[E=\int_{O}{L(\mathbf{\omega})\mathrm{d}\mathbf{\omega}}\]

<p>Under certain circumstances we may want to precompute-and-store the incoming radiance \(L\) at a point or a collection of points in the scene in order to approximate illumination dynamically in real-time (possibly making use of \(E\) somehow).</p>

<p>\(L\) is a function defined on the sphere, and is called light probe…</p>

<p>\(E\) shows up in the <a href="https://en.wikipedia.org/wiki/Rendering_equation">Rendering Equation</a> but again, in this post we’re only interested in an efficient way to precompute-and-store \(L(\mathbf{\omega})\).</p>

<p>In a real scenario, light probes can be placed either manually or automatically and they are meant to suffciently cover the scene. The goal of each individual light probe is to keep track of what illumination looks like in the volumetric neighborhood of the point they are centered at. Typically, nearby light probes are sampled and the samples obtained are interpolated to figure out the illumination arriving at any given 3D point. This can give a decent and fast-to-query approximation to Global Illumination and/or soft shadowing.</p>

<p>The information stored by a light probe can be pictured of as a panoramic view of what the point sees around itself. So typical ways to initialize (or update) a light probe are to literally render/rasterize the scene around (maybe with 6 cubemap-arranged cameras) or ray-tracing the surroundings stochastically.</p>

<p>Whichever the method, the resulting irradiance is a spherical collection of colors-and-their-magnitudes. Or, in better words, a function defined on the sphere which yields a color when evaluated at each unit direction. Which, in more humane terms, is a \(360\deg\) photograph of the scene from the point (a panorama or a cubemap if you prefer).</p>

<p>Those are usually rather heavy, and since scenes typically require (many) thousands of light probes to sufficiently cover their volume, finding a highly efficient and performant (albeit lossless) way to encode such spherical color maps sounds ideal.</p>

<p>It is important to note that such radiances-arriving-at-a-point maps can be very high-frequency as soon as we involve high-intensity point lights (such as the sun) and hard shadows. So in some engines all direct lighting coming from hard lights is calculated dynamically and light probes are used exclusively for indirect illumination and soft shadowing, which is much lower frequency.</p>

<p>So let’s establish the goal of this post as:</p>

<blockquote>
  <p>Find a highly efficient/performant way to encode (low-frequency) spherical color maps with as little loss as possible.</p>
</blockquote>

<h3 id="cubemaps">Cubemaps</h3>

<p>Throughout this post I will display \(L(\mathbf{\omega})\) as cubemaps because cubemap projections exhibit little distortion compared to angular or latitude-longitude maps.</p>

<p>It is important to note that in doing so, the integrals we will be calculating below need to account for distortion in their differential element.</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-differential.png" alt="Directions and differentials" /></p>

<p>The rgb-coded cubemap represents all the unit directions in a sphere \(\mathbf{\omega}\). The grayscale cubemap represents the differential element conversion between the unit sphere and the unit cubemap \(\mathrm{d}\mathbf{\omega}\). The HDR map unfolded as a cubemap is an example of an incoming radiance map \(L(\mathbf{\omega})\).</p>

<p>Sanity check: The sum of all the grayscale patches must be \(4\pi\) = the surface of the unit sphere.</p>

<h2 id="spherical-harmonics">Spherical Harmonics</h2>

<p>SHs have no particular connection with rendering or radiance encoding. They are a generic mathematical contraption with which you can <em>project</em> some input data given in an input realm (usually space) onto another realm (usually frequency-related). This projection process is also reversible, which allows for encoding/decoding.</p>

<p>This is all quite reminiscent of the Fourier Transform &amp; Co..</p>

<p>SH are particularly interesting in the context of Computer Graphics because their domain is the unit sphere, which makes them ideal to encode <em>directional information</em>, such as light probes as described above.</p>

<h3 id="orthogonality-and-key-properties">Orthogonality and Key Properties</h3>

<p>Spherical Harmonics have several mathematical properties that make them ideal for encoding spherical functions:</p>

<p><strong>Orthogonality:</strong> The SH functions are orthogonal over the sphere. This property allows us to decompose any spherical function into independent components without interference between different harmonics.</p>

<p><strong>Completeness:</strong> Any square-integrable function on the sphere can be represented as a linear combination of spherical harmonics. For rendering, this means we can approximate any incoming radiance distribution to arbitrary precision by using enough SH coefficients.</p>

<p><strong>Rotation Invariance:</strong> The total power in each frequency band (each level \(l\)) is preserved under rotation. This makes SH coefficients stable when objects or light probes are rotated.</p>

<p><strong>Frequency Separation:</strong> Lower-order harmonics capture low-frequency (smooth) variations, while higher-order harmonics capture high-frequency (detailed) variations. This natural frequency ordering makes SH perfect for level-of-detail approximations.</p>

<p>From Wikipedia:</p>

<p><em>“Since the Spherical Harmonics form a complete set of orthogonal functions and thus an orthonormal basis, each function defined on the surface of a sphere can be written as a sum of these spherical harmonics.”</em></p>

<h3 id="what-the-shs-look-like">What the SHs look like</h3>

<p>Laplace’s Spherical Harmonics are denoted \(Y_l^m(\omega)\) where:</p>

<ul>
  <li>\(l\) is called the <strong>degree</strong> or <strong>order</strong> (ranging from 0 to infinity in theory, but we truncate for practical use).</li>
  <li>\(m\) is called the <strong>order within degree</strong> (ranging from \(-l\) to \(+l\)).</li>
</ul>

<p>For a given order \(l\), there are \(2l+1\) different harmonics, each identified by a different value of \(m\). This gives us:</p>
<ul>
  <li>Level 0 (\(l=0\)): 1 harmonic</li>
  <li>Level 1 (\(l=1\)): 3 harmonics</li>
  <li>Level 2 (\(l=2\)): 5 harmonics</li>
  <li>Level 3 (\(l=3\)): 7 harmonics</li>
  <li>Total for \(L\) levels: \(L^2\) harmonics</li>
</ul>

<p>The harmonics are essentially different “shapes” or “patterns” on the sphere that form an orthogonal basis. Below is my implementation for the first 4 levels</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k01</span> <span class="o">=</span> <span class="mf">0.2820947918</span><span class="p">;</span>  <span class="c1">// sqrt(  1/pi)/2.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k02</span> <span class="o">=</span> <span class="mf">0.4886025119</span><span class="p">;</span>  <span class="c1">// sqrt(  3/pi)/2.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k03</span> <span class="o">=</span> <span class="mf">1.0925484306</span><span class="p">;</span>  <span class="c1">// sqrt( 15/pi)/2.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k04</span> <span class="o">=</span> <span class="mf">0.3153915652</span><span class="p">;</span>  <span class="c1">// sqrt(  5/pi)/4.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k05</span> <span class="o">=</span> <span class="mf">0.5462742153</span><span class="p">;</span>  <span class="c1">// sqrt( 15/pi)/4.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k06</span> <span class="o">=</span> <span class="mf">0.5900435860</span><span class="p">;</span>  <span class="c1">// sqrt( 70/pi)/8.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k07</span> <span class="o">=</span> <span class="mf">2.8906114210</span><span class="p">;</span>  <span class="c1">// sqrt(105/pi)/2.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k08</span> <span class="o">=</span> <span class="mf">0.4570214810</span><span class="p">;</span>  <span class="c1">// sqrt( 42/pi)/8.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k09</span> <span class="o">=</span> <span class="mf">0.3731763300</span><span class="p">;</span>  <span class="c1">// sqrt(  7/pi)/4.</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">m_k10</span> <span class="o">=</span> <span class="mf">1.4453057110</span><span class="p">;</span>  <span class="c1">// sqrt(105/pi)/4.</span>

<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_0_0</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span>   <span class="p">)</span> <span class="p">{</span> <span class="k">return</span>    <span class="n">m_k01</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_1_0</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k02</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_1_1</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span>  <span class="n">m_k02</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_1_2</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k02</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="p">);</span> <span class="p">}</span>

<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_2_0</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span>  <span class="n">m_k03</span> <span class="o">*</span>               <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span>                         <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_2_1</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k03</span> <span class="o">*</span>               <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span>                         <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_2_2</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span>  <span class="n">m_k04</span> <span class="o">*</span>       <span class="p">(</span> <span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="p">)</span> <span class="o">-</span>   <span class="mi">1</span>               <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_2_3</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k03</span> <span class="o">*</span>               <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span>                         <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_2_4</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span>  <span class="n">m_k05</span> <span class="o">*</span>       <span class="p">(</span> <span class="p">(</span>     <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span>     <span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>

<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_3_0</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k06</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span>     <span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_3_1</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span>  <span class="n">m_k07</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span>     <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="p">)</span>                     <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_3_2</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k08</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mi">1</span>             <span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_3_3</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span>  <span class="n">m_k09</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mi">3</span>             <span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_3_4</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k08</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mi">1</span>             <span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_3_5</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span>  <span class="n">m_k10</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span>     <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span>     <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">T</span> <span class="nf">Y_3_6</span><span class="p">(</span> <span class="k">const</span> <span class="n">V3_t</span><span class="o">&amp;</span> <span class="n">n</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span> <span class="o">-</span><span class="n">m_k06</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span>     <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">y</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
</code></pre></div></div>

<p>This spherical (<em>i.e.,</em> polar in 3D) plot represents the SH basis for the first four levels (L0-L1-L2-L3). The SH magnitude is used for the radius at each spherical coord and the sign is used for the color.</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics.jpg" alt="L0-L1-L2-L3 Spherical Harmonics" /></p>

<p>This is the same type of plot, but fixating \(r=1\) and using the magnitude/sign to interpolate between both colors. Note that I have thresholded the magnitude a bit so sign-flip boundaries more sharply distinct.</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-unit.jpg" alt="Trajectory constraint" /></p>

<p>This is again the same plot, but now each unit sphere is unfolded in a cubemap layout. The same color thresholding is used here.</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-cubemap.jpg" alt="Trajectory constraint" /></p>

<h3 id="what-the-shs-will-do-for-us">What the SHs will do for us</h3>

<p>Recap: The radiance arriving at a point from all directions is a fundamental building block in many real-time GI approximation algorithms. Let’s use the term light probe from now on.</p>

<p>A light probe stores what a point in space <em>sees</em> if it <em>looks around</em>. In other words, a light probe is nothing but a <em>render of the scene</em> with a <em>spherical cam</em> centered at the point.</p>

<p>The radiance arriving at a point from all directions is precisely a (color) function defined on the surface of a sphere centered at the point. Thus, we can encode arriving directional radiance with SHs.</p>

<h2 id="encodingdecoding">Encoding/Decoding</h2>

<p>Let’s define some terminology here:</p>

<p>L: Number of SH levels we will use.</p>

<p>Each level contributes \(L+1+L\) SHs.</p>

<p>So, for example, if we choose \(L=4\), then the total number of SHs involved will be \(N_{SH}=1+3+5+7=16\). It can be easily proven that for any \(L\), the total number of SHs will be \(N_{SH}=L^2\).</p>

<p><strong>Encoding:</strong> The process of projecting the input panorama onto each of the \(N_{SH}\) harmonics. This process yields exactly \(N_{SH}\) real coefficients.</p>

<p><strong>Decoding:</strong> The process of restoring the input panorama with the linear combination of those \(N_{SH}\) real coefficients each multiplied by its corresponding harmonic.</p>

<p><strong>SH codec:</strong> This is the shortname with which we will refer to the process of encoding-and-decoding an input panorama.</p>

<p>Naturally, the higher the number of levels \(L\) the lower the loss of information. But also the number of coefficients (storage and mathematical operations required) will grow quadratically.</p>

<p>For light probes in real-time \(L=3\) or \(L=4\) are usual choices. Radiance arriving at a point is hoefully low-frequency, so few coefficients offer a good compromise between detail preservation and storage size.</p>

<p>It goes without saying, but the SH codec is called once per color component (<em>i.e.,</em> \(3\) times per component). This also means that the actual number of real coefficients for a color input panorama is \(3L^2\).</p>

<h3 id="ldr-panorama">LDR panorama</h3>

<p>Let’s start with this panorama taken from <a href="https://commons.wikimedia.org/wiki/File:Harderwijk_harbour_2018_-_360_panorama.jpg">commons.wikimedia.org</a>. The image is 8-bit, Low-Dynamic-Range, and not particularly high-frequency. <em>i.e.,</em> a 360-degree panorama of a pretty exterior.</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-ldr.png" alt="LDR panorama" /></p>

<p>Here’s what happens if we pass it through our SH codec with \(L=3\) (\(9 \times 3=27\) coefficients).</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-ldr-9x3.png" alt="SH reconstruction LDR 27" /></p>

<p>Now with \(L=4\) (\(16 \times 3=48\) coefficients).</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-ldr-16x3.png" alt="SH reconstruction LDR 48" /></p>

<p>And now with \(L=10\) (\(100 \times 3=300\) coefficients).</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-ldr-100x3.png" alt="SH reconstruction LDR 300" /></p>

<blockquote>
  <p>You can right-click and download (or open in another tab) to view these images at 1:1 scale.</p>
</blockquote>

<p>The more the SHs (and coefficients) the more faithful and detailed the reconstruction becomes. While this is obvious, it is important to remark that the SH basis we’re using is “ordered by frequency”, meaning that the first ones encode lower-frequency bands, and adding more and more SHs adds more and more higher-frequency bands. In the continuous case, an infinite number of SHs and coefficients would be required to guarantee an ever lossless restoration. In the discrete case, as with the FT and other transforms, a finite amount of coefficients (proportional to the input data size) will suffice.</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-ldr-progression.gif" alt="SH reconstruction progression" /></p>

<p>Let’s try with a spherically-blurred version (not a regular image blur):</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-ldr-blurred-progression.gif" alt="SH reconstruction progression" /></p>

<p>The most important takeaway here is:</p>

<blockquote>
  <p>With just a handful of floating-point coefficients we are able to reconstruct a decent low-frequency approximation to an arbitrarily large-resolution panoramic view of a scene. The encoding/decoding process is defined by a very compact and fairly efficient formulation.</p>
</blockquote>

<p>Now, how well-behaved an SH codec is? Does it also work well with more complicated data?</p>

<h3 id="hdr-panorama">HDR panorama</h3>

<p>Since an SH codec transforms data from its natural space domain to the frequency domain, one can reasonably expect that the type of frequencies found in the original data will greatly affect the amount of SH levels (coefficients) necessary to reconstruct data more or less faithfully.</p>

<p>Meaning that data with higher frequencies will be encoded at a greater loss. This sounds intuitive. But there is other less obvious and more harmful implication. As soon as high frequencies appear in the data, artifacts (and not just a loss of detail) will start to appear. <em>Ringing</em> in particular.</p>

<p>This is nothing but a manifestation of the well-known <a href="https://en.wikipedia.org/wiki/Gibbs_phenomenon">Gibbs phenomenon</a>.</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-hdr-1.gif" alt="SH reconstruction progression" /></p>

<p>Higher frequencies in an image semantically mean more fine/sharp detail (<em>i.e.,</em> more average variation from one pixel to its neighbors). But another factor that amplifies the amount of variation is the dynamic range of the data. Having a high-dynamic range may or may not affect what frequencies are present, but will certainly affect the amplitudes (the magnitude) of the encoded coefficients. Since the harmonics are wave-like, ringing may occur.</p>

<p>The only true solution to this problem would be to keep adding more and more levels/coefficients. But that is obviously not an option. So we may be forced to cheat a little:</p>

<ul>
  <li>Reduce or clamp the dynamic range (HDR-&gt;LDR).</li>
  <li>Blur the input data to shave off the higher frequencies.</li>
</ul>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-hdr-clamped.gif" alt="SH reconstruction progression" /></p>

<p>Let’s try with another classic HDR panorama. High-frequencies and high-amplitudes together cause a wobbly disaster:</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-hdr-2.gif" alt="SH reconstruction progression" /></p>

<p>And now let’s try with a spherically-blurred version of the same map. The particular blur I am using here is a cosine-weighted hemispherical blur:</p>

<p><img src="/uploads/2025/spherical-harmonics/chemaguerra-spherical-harmonics-hdr-blurred.gif" alt="SH reconstruction progression" /></p>

<p>Because type of blur used is cosine-weighted over the hemisphere, this light probe exactly captures the irradiance that a <em>lambertian surface</em> would receive from the scene if illuminated with the unblurred HDR panorama.</p>

<p>And this is precisely what SH encoding/decoding is good for:</p>

<h2 id="valuable-resources">Valuable resources</h2>

<p>These are “mandatory” resources with great in-depth explanations:</p>

<ul>
  <li><a href="http://www.ppsloan.org/publications/StupidSH36.pdf">Stupid Spherical Harmonics Tricks</a> by Peter-Pike Sloan.</li>
  <li><a href="https://graphics.stanford.edu/papers/envmap/">An Efficient Representation for Irradiance Environment Maps</a> by Ramamoorthi and Hanrahan.</li>
  <li><a href="http://www.cse.chalmers.se/~uffe/xjobb/Readings/GlobalIllumination/Spherical%20Harmonic%20Lighting%20-%20the%20gritty%20details.pdf">Spherical Harmonic Lighting: The Gritty Details</a> by Robin Green.</li>
</ul>

  </div><a class="u-url" href="/2025/08/25/spherical-harmonics.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <h2 class="footer-heading">Chema Guerra</h2>
        <ul class="contact-list">
          <li class="p-name"><a class="u-email" href="mailto:brashandplucky@gmail.com">brashandplucky@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li>
    <a href="https://x.com/chemaguerra">
      <svg class="svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="currentColor"/>
      </svg>
      <span class="username">@chemaguerra</span>
    </a>
  </li>
  <li>
    <a href="https://x.com/topotoylabs">
      <svg class="svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="currentColor"/>
      </svg>
      <span class="username">@topotoylabs</span>
    </a>
  </li>
</ul></div>

      <div class="footer-col footer-col-3">
        <p>This is a coding blog where I post about the various projects that I am currently working on, both at work, or as an independent researcher. Most content here revolves around computer graphics and physics simulation.</p>
      </div>
    </div>

  </div>

</footer></body>

</html>
