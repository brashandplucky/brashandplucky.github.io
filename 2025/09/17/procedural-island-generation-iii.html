<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Chema Guerra" /><!-- favicon -->
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <!-- MathJax -->
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Open Graph cards -->
    <meta property="og:url" content="http://0.0.0.0:4000/2025/09/17/procedural-island-generation-iii.html">
    <meta property="og:title" content="Procedural Island Generation (III)">
    <meta property="og:description" content="Adding multi-scale noise layers, mountain distance fields, and elevation blending to create detailed terrain from the paint map foundation.">
    <meta property="og:image" content="http://0.0.0.0:4000/thumbnails/2025/chemaguerra-procedural-island-generation-iii.png">
    <meta property="og:type" content="article">
    <!-- Twitter cards -->
    <meta name="twitter:site" content="@chemaguerra">
    <meta name="twitter:creator" content="@Chema Guerra">
    <meta name="twitter:title" content="Procedural Island Generation (III)">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Adding multi-scale noise layers, mountain distance fields, and elevation blending to create detailed terrain from the paint map foundation.">
    <meta name="twitter:image" content="http://0.0.0.0:4000/thumbnails/2025/chemaguerra-procedural-island-generation-iii.png">
    <meta name="twitter:image:src" content="http://0.0.0.0:4000/thumbnails/2025/chemaguerra-procedural-island-generation-iii.png">
    
    <!-- Make post images clickable to enlarge -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Find all images in post content and page content.
      var images = document.querySelectorAll('.post-content img, .page-content img');
      
      images.forEach(function(img) {
        // Skip if already wrapped in a link.
        if (img.parentElement.tagName === 'A') return;
        
        // Create link wrapper.
        var link = document.createElement('a');
        link.href = img.src;
        link.target = '_blank';
        link.title = 'Click to enlarge';
        
        // Wrap image with link.
        img.parentNode.insertBefore(link, img);
        link.appendChild(img);
        
        // Add cursor style.
        img.style.cursor = 'zoom-in';
      });
      
      // Make all external links open in new tab.
      var links = document.querySelectorAll('.post-content a, .page-content a');
      links.forEach(function(link) {
        // Check if link is external (not same domain).
        if (link.hostname && link.hostname !== window.location.hostname) {
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
        }
      });
    });
    </script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chema Guerra</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/archive/">Archive</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Procedural Island Generation (III)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-09-17T00:00:00+02:00" itemprop="datePublished">Sep 17, 2025
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Chema Guerra</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-terrain-elevation-detailed.png" alt="Terrain elevation with noise layers" />
  <figcaption>Resulting terrain elevation with multi-scale noise layers and mountain peaks</figcaption>
</figure>

<p>This post continues from <a href="/2025/09/10/procedural-island-generation-ii.html">Part II</a>, where we established the paint map foundation and mountain ridge system. Now we’ll add detailed noise layers, distance-based mountain peaks, and do blending to create the final terrain elevation.</p>

<h2 id="paint-map-recap">Paint Map (recap)</h2>

<p>Before applying noise layers, we start with the foundation established in Part I - the paint map that defines our base land/water distribution:</p>

<figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-paint-map-part-i.png" alt="Paint map from Part I" />
  <figcaption>The paint map from Part I - our starting elevation values before noise enhancement</figcaption>
</figure>

<p>For visualization throughout this post, we’ll be using the magma palette from matplotlib, which I patched to artificially darken the ocean areas to highlight the coastline:</p>

<figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-paint-map-triangulated.png" alt="Paint map sampled at triangle centroids" />
  <figcaption>Paint map values sampled at the centroids of Delaunay triangles</figcaption>
</figure>

<p>Note that we’ll be sampling the paint map <em>per Delaunay triangle</em> (at each triangle’s centroid):</p>

<figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-paint-map-triangulated-center.png" alt="Central portion of triangulated paint map" />
  <figcaption>Central portion of the above image showing the per-triangle sampling more clearly</figcaption>
</figure>

<p>Remember that the paint map provides the broad strokes: positive values for land, negative for ocean, with smooth transitions between them. Now we’ll enhance it with noise layers to create realistic terrain detail.</p>

<h2 id="multi-scale-noise-layers">Multi-Scale Noise Layers</h2>

<p>We will layer multiple octaves of Simplex noise at different frequencies over the broad strokes provided by the paint map. Each will contribute different detail scales to the final terrain.</p>

<p><a href="https://github.com/redblobgames/mapgen4">mapgen4</a> by <a href="https://x.com/redblobgames">@redblobgames</a> in particular uses six layers:</p>

<figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-noise-fields-combined.png" alt="Noise field visualization" />
  <figcaption>All six noise fields at different frequencies (1x, 2x, 4x, 16x, 32x, 64x) shown in a 3x2 grid</figcaption>
</figure>

<figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-noise-triangulated.png" alt="Triangulated noise field" />
  <figcaption>Top-left corner of n<sub>2</sub> - Note that we are sampling the noises at the (centroids of the) triangles.</figcaption>
</figure>

<table>
  <thead>
    <tr>
      <th>Layer</th>
      <th>Frequency</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>n₀</td>
      <td>1x</td>
      <td>Lowest frequency</td>
    </tr>
    <tr>
      <td>n₁</td>
      <td>2x</td>
      <td>Low frequency</td>
    </tr>
    <tr>
      <td>n₂</td>
      <td>4x</td>
      <td>Medium-low frequency</td>
    </tr>
    <tr>
      <td>n₄</td>
      <td>16x</td>
      <td>Medium-high frequency</td>
    </tr>
    <tr>
      <td>n₅</td>
      <td>32x</td>
      <td>High frequency</td>
    </tr>
    <tr>
      <td>n₆</td>
      <td>64x</td>
      <td>Highest frequency</td>
    </tr>
  </tbody>
</table>

<p>Notice the gap in numbering (n₃ is missing). This would correspond to frequency 8x, which we don’t use.</p>

<h3 id="coastal-noise-enhancement">Coastal Noise Enhancement</h3>

<p>mapgen4 starts with coastal noise enhancement. This provides control over the variation at coastlines while keeping inland elevation unaffected:</p>

\[e = \text{Paint map from Part I}\]

\[e_{coast} = e + \alpha \cdot (1 - e^4) \cdot \left(n_4 + \frac{n_5}{2} + \frac{n_6}{4}\right)\]

<p>The term \((1 - e^4)\) creates a bell curve that peaks at \(e=0\) (coastline) and decreases rapidly for \(\lvert e \rvert &gt; 0\). This modulates an fBm-like combination of our three highest frequency noise layers.</p>

<p>What matters here isn’t the exact formula or amplitudes, but the core principle: applying high-frequency detail specifically where land meets water.</p>

\[e_{tmp} = \begin{cases}
e &amp; \text{if } e_{coast} &gt; 0 \\
e_{coast} &amp; \text{if } e_{coast} \leq 0
\end{cases}\]

<figure>
  <video autoplay="" loop="" muted="" playsinline="" style="width: 512px; height: 512px;">
    <source src="/uploads/2025/procedural-island-generation-iii/chemaguerra-noisy-coastlines-variation.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <figcaption>e<sub>tmp</sub> with varying α - Showing its effect on coastline and seabed complexity</figcaption>
</figure>

<h2 id="mountain-distance-field">Mountain Distance Field</h2>

<p>Mountains need special pre-processing. If you remember from <a href="/2025/09/07/procedural-island-generation-i.html">Part I</a> in the swarm of seed points we tagged some as mountain peaks. Here we will pre-compute a <em>distance field</em> from every regular seed point to the closest mountain peak point.</p>

<p>We compute distance through the mesh topology of the Delaunay triangulation using BFS (breadth-first search). <em>i.e.,</em> we don’t use Euclidean distance. This creates more organic mountain shapes that follow the terrain’s natural connectivity.</p>

<p>The algorithm spreads outward from mountain peaks:</p>
<ol>
  <li>Start at triangles containing mountain seed points (distance = 0)</li>
  <li>Visit neighboring triangles, incrementing distance by a randomized amount</li>
  <li>The randomization creates natural ridge patterns instead of perfect cones</li>
</ol>

<p>Here’s the magic formula used for distance increment in each step:</p>

\[\Delta = s \cdot (1 + j \cdot r)\]

<p>Where:</p>
<ul>
  <li>\(s\) = spacing between triangles (uses configured Poisson disk separation)</li>
  <li>\(j\) = jaggedness parameter (0 = true topological distance, 1 = very irregular)</li>
  <li>\(r \in [-1,1]\) = random factor using triangular distribution</li>
</ul>

<p>The triangular distribution <code class="language-plaintext highlighter-rouge">rand() - rand()</code> clusters values near zero while allowing occasional larger variations. This looks more natural than uniform randomness.</p>

<p>I implemented <a href="https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle">Fisher-Yates shuffling</a> when visiting neighbor triangles. Instead of processing neighbors in a fixed order (which would create directional bias), the order is randomly shuffled each time. This ensures mountain ridges branch out organically in all directions rather than following predictable patterns.</p>

<p>After computing distances this way, we normalize them (by the max dist, for example):</p>

<figure>
  <video autoplay="" loop="" muted="" playsinline="" style="width: 512px; height: 512px;">
    <source src="/uploads/2025/procedural-island-generation-iii/chemaguerra-mountain-distance-field-jaggedness.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <figcaption>d<sub>m</sub> - Normalized mountain distance field with varying jaggedness parameter</figcaption>
</figure>

<h2 id="elevation-blending">Elevation Blending</h2>

<p>The final elevation combines all components through weighted blending:</p>

\[e_{final} = \begin{cases}
\text{lerp}(e_{hill}, e_{mountain}, e_{coast}^2) &amp; \text{if } e_{coast} &gt; 0 \\
e_{coast} \cdot (\rho + n_1) &amp; \text{if } e_{coast} \leq 0
\end{cases}\]

<p>Where:</p>

<ul>
  <li>\(e_{hill} = h \cdot \bigl(1 + \text{lerp}(n_2, n_4, \tfrac{1 + n_0}{2})\bigr)\) =&gt; hill elevation with noise-modulated height</li>
  <li>\(e_{mountain} = 1 - \frac{\mu}{2^\sigma} \cdot d_m\) =&gt; mountain elevation from distance field</li>
</ul>

<p>The quadratic blend weight produces smooth transitions from hills near the coast through mixed terrain at mid-elevations to pure mountains at peaks.</p>

<p>With (editable) parameters:</p>

<ul>
  <li>\(\alpha\): Coastal noise strength (0.01)</li>
  <li>\(h\): Hill height scale (0.02)</li>
  <li>\(\rho\): Ocean depth multiplier (1.5)</li>
  <li>\(\mu\): Mountain slope (17.6)</li>
  <li>\(\sigma\): Mountain sharpness (9.8)</li>
</ul>

<h3 id="interactive-parameter-exploration">Interactive Parameter Exploration</h3>

<figure>
  <video autoplay="" loop="" muted="" playsinline="" style="width: 512px; height: 512px;">
    <source src="/uploads/2025/procedural-island-generation-iii/chemaguerra-mountain-sharpness-variation.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <figcaption>Terrain elevation with varying mountain sharpness σ</figcaption>
</figure>

<figure>
  <video autoplay="" loop="" muted="" playsinline="" style="width: 512px; height: 512px;">
    <source src="/uploads/2025/procedural-island-generation-iii/chemaguerra-mountain-jaggedness-elevation.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <figcaption>Terrain elevation with varying mountain jaggedness j</figcaption>
</figure>

<figure>
  <video autoplay="" loop="" muted="" playsinline="" style="width: 512px; height: 512px;">
    <source src="/uploads/2025/procedural-island-generation-iii/chemaguerra-hill-height-variation.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <figcaption>Terrain elevation with varying hill height scale h</figcaption>
</figure>

<figure>
  <video autoplay="" loop="" muted="" playsinline="" style="width: 512px; height: 512px;">
    <source src="/uploads/2025/procedural-island-generation-iii/chemaguerra-ocean-depth-variation.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
  <figcaption>Terrain elevation with varying ocean depth multiplier ρ</figcaption>
</figure>

<h2 id="region-vs-triangle-elevation">Region (vs. Triangle) Elevation</h2>

<p>So far we’ve computed elevation for triangles. But our Voronoi regions (from Part I) also need elevations for certain stages in the rest of the series.</p>

<figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-triangle-region-full-animation.gif" alt="Triangle vs Region elevation animation" />
  <figcaption>Animation comparing triangle elevation vs region elevation (1 second each)</figcaption>
</figure>

<p>Each seed point defines a Voronoi region and serves as a vertex in multiple Delaunay triangles. To assign elevation to a Voronoi region, we average the elevations of all triangles that share its seed point as a vertex.</p>

<figure>
  <img src="/uploads/2025/procedural-island-generation-iii/chemaguerra-triangle-region-animation.gif" alt="Triangle vs Region elevation animation" style="width: 512px; height: 512px;" />
  <figcaption>Central detail animating between triangle elevation and region elevation (1 second each)</figcaption>
</figure>

<h2 id="next-steps">Next Steps</h2>

<p>With elevation complete, our island has shape but lacks the defining features carved by water. Part IV will simulate the hydrological cycle: rainfall patterns influenced by topography, rivers flowing from peaks to ocean, and valleys carved by erosion.</p>

<h2 id="valuable-resources">Valuable Resources</h2>

<ul>
  <li><a href="https://www.redblobgames.com/maps/terrain-from-noise/">Terrain from Noise</a> - Amit Patel’s Red Blob Games guide to layering noise for terrain</li>
  <li><a href="https://www.redblobgames.com/x/1843-planet-generation/">Polygonal Map Generation</a> - Red Blob Games on Voronoi-based terrain (mapgen4 inspiration)</li>
  <li><a href="https://www.redblobgames.com/x/1723-procedural-river-growing/">Distance Fields for Terrain</a> - Red Blob Games on using distance fields in terrain generation</li>
</ul>

  </div><a class="u-url" href="/2025/09/17/procedural-island-generation-iii.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <h2 class="footer-heading">Chema Guerra</h2>
        <ul class="contact-list">
          <li class="p-name"><a class="u-email" href="mailto:brashandplucky@gmail.com">brashandplucky@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li>
    <a href="https://x.com/chemaguerra">
      <svg class="svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="currentColor"/>
      </svg>
      <span class="username">@chemaguerra</span>
    </a>
  </li>
  <li>
    <a href="https://x.com/topotoylabs">
      <svg class="svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="currentColor"/>
      </svg>
      <span class="username">@topotoylabs</span>
    </a>
  </li>
</ul></div>

      <div class="footer-col footer-col-3">
        <p>This is a coding blog where I post about the various projects that I am currently working on, both at work, or as an independent researcher. Most content here revolves around computer graphics and physics simulation.</p>
      </div>
    </div>

  </div>

</footer></body>

</html>
